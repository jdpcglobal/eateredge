(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[249],{77293:function(e,a,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/Order",function(){return s(40622)}])},80317:function(){},27701:function(){},3877:function(){},11163:function(e,a,s){e.exports=s(37253)},40622:function(e,a,s){"use strict";s.r(a),s.d(a,{default:function(){return m}});var t=s(85893),r=s(67294),l=s(99603),o=s(59417);s(27701),s(3877);var n=s(21441),i=s(27875),c=s(87066),d=e=>{let{setShowPopup:a,location:s,setLocation:n,flatNo:i,setFlatNo:d,landmark:u,setLandmark:h,adminLocation:m,distanceThreshold:p,setSavedAddresses:g}=e,v=(0,r.useRef)(null),[x,f]=(0,r.useState)(null),[j,N]=(0,r.useState)(null),y=(0,r.useRef)(null),[w,k]=(0,r.useState)(!0),[S,b]=(0,r.useState)({location:"",flatNo:"",landmark:""}),[F,C]=(0,r.useState)(!1),E=!1,A=()=>{if(E)return;let e=document.createElement("script");e.src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCuro_Das6SA4HRZzGnqR6VHHgyfprryCg&libraries=places",e.async=!0,document.body.appendChild(e),e.onload=()=>{E=!0,I()}},I=()=>{if(window.google&&v.current){let e={lat:26.9124,lng:75.7873},a=new window.google.maps.Map(v.current,{center:e,zoom:12});f(a),y.current=new window.google.maps.Geocoder;let s=new window.google.maps.Marker({position:e,map:a,draggable:!0});N(s),a.addListener("click",e=>{let a=e.latLng;s.setPosition(a),D(a)}),s.addListener("dragend",()=>{D(s.getPosition())})}};(0,r.useEffect)(()=>{A()},[]);let D=e=>{y.current&&y.current.geocode({location:e},(a,s)=>{"OK"===s&&a[0]?(n(a[0].formatted_address),_(e)):alert("Failed to retrieve address. Please try again.")})},_=e=>{if(!window.google||!m)return;let a=new window.google.maps.DistanceMatrixService;y.current.geocode({address:m},(s,t)=>{if("OK"===t&&s[0]){let t=s[0].geometry.location;a.getDistanceMatrix({origins:[t],destinations:[e],travelMode:window.google.maps.TravelMode.DRIVING},(e,a)=>{"OK"===a?k(e.rows[0].elements[0].distance.value/1e3<=p):alert("Error calculating distance")})}else alert("Failed to retrieve admin location")})},P=async()=>{C(!0);let e={location:"",flatNo:"",landmark:""},t=!1;if(s||(e.location="Please fill this field",t=!0),i||(e.flatNo="Please fill this field",t=!0),u||(e.landmark="Please fill this field",t=!0),b(e),t){C(!1);return}if(!w){alert("Delivery is not available for this location"),C(!1);return}let r=localStorage.getItem("token");if(!r){alert("User not authenticated"),C(!1);return}try{let e=await c.Z.post("/api/address",{token:r,location:s,flatNo:i,landmark:u});if(e.data.success){let s=e.data.address;g(e=>[s,...e]),n(""),d(""),h(""),b({}),a(!1)}else alert("Error: ".concat(e.data.message))}catch(e){console.error("Error saving address:",e),alert("An unexpected error occurred")}finally{C(!1)}};return(0,t.jsx)("div",{className:"popup-container",children:(0,t.jsxs)("div",{className:"popup",children:[(0,t.jsxs)("div",{className:"popup-header",children:[(0,t.jsx)("h3",{children:"Save Delivery Address"}),(0,t.jsx)(l.G,{icon:o.NBC,className:"remove-icon",onClick:()=>a(!1)})]}),(0,t.jsx)("div",{className:"map-container",children:(0,t.jsx)("div",{ref:v,className:"map"})}),!w&&(0,t.jsx)("p",{className:"error-message",children:"Delivery is not available for this location."}),(0,t.jsxs)("p",{className:"locate",children:[(0,t.jsx)("input",{type:"text",placeholder:"Enter Address",value:s,onChange:e=>n(e.target.value),className:"input-field1"}),(0,t.jsx)("button",{className:"locate-me-btn",onClick:()=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{let a={lat:e.coords.latitude,lng:e.coords.longitude};x&&j&&(x.setCenter(a),j.setPosition(a),D(a))},e=>{alert("Error getting location: "+e.message)},{timeout:1e4}):alert("Geolocation is not supported by this browser.")},children:"Locate Me"})]}),S.flatNo&&(0,t.jsx)("span",{className:"error-text",children:S.flatNo}),(0,t.jsx)("input",{type:"text",placeholder:"Flat No.",value:i,onChange:e=>d(e.target.value),className:"input-field ".concat(S.flatNo?"error-border":"")}),S.landmark&&(0,t.jsx)("span",{className:"error-text",children:S.landmark}),(0,t.jsx)("input",{type:"text",placeholder:"Landmark",value:u,onChange:e=>h(e.target.value),className:"input-field ".concat(S.landmark?"error-border":"")}),(0,t.jsx)("button",{className:"save-address-btn",onClick:P,disabled:F,children:F?(0,t.jsx)("span",{className:"loading-spinner"}):"Save Address"})]})})},u=s(15010),h=s(11163);s(80317),s(72422);var m=()=>{let[e,a]=(0,r.useState)(!1),[s,m]=(0,r.useState)(""),[p,g]=(0,r.useState)(""),[v,x]=(0,r.useState)(""),[f,j]=(0,r.useState)([]),[N,y]=(0,r.useState)(null),[w,k]=(0,r.useState)(!1),[S,b]=(0,r.useState)(!1),[F,C]=(0,r.useState)([]),[E,A]=(0,r.useState)(null),[I,D]=(0,r.useState)(null),[_,P]=(0,r.useState)(!0),[L,Z]=(0,r.useState)(null),[T,G]=(0,r.useState)(""),[M,O]=(0,r.useState)(12),[z,R]=(0,r.useState)(0),B=(0,h.useRouter)(),[H,K]=(0,r.useState)(null),[q,V]=(0,r.useState)(!1);if((0,r.useEffect)(()=>{V(!0)},[]),!q)return null;(0,r.useEffect)(()=>{let e=()=>{localStorage.removeItem("token"),b(!1),k(!0),B.push("/")},a=async()=>{try{let e=await c.Z.get("/api/adminSettings");e.data.success?(G(e.data.adminLocation),O(e.data.distanceThreshold)):console.error("Failed to fetch admin settings")}catch(e){console.error("Error fetching admin settings:",e.message)}},s=async a=>{try{let e=await c.Z.get("/api/getAddresses",{headers:{Authorization:"Bearer ".concat(a)}});e.data.success&&j(e.data.deliveries)}catch(a){var s;(null===(s=a.response)||void 0===s?void 0:s.status)===401?e():console.error("Error fetching saved addresses:",a.message)}},t=async a=>{try{let e=await c.Z.get("/api/getCartItems",{headers:{Authorization:"Bearer ".concat(a)}});e.data.success?C(e.data.cartItems):y(e.data.message)}catch(a){var s;(null===(s=a.response)||void 0===s?void 0:s.status)===401?e():console.error("Error fetching cart items:",a.message)}},r=async a=>{try{let e=await c.Z.get("/api/getCartInfo",{headers:{Authorization:"Bearer ".concat(a)}});e.data.success?(D(e.data.cartTotal),Z(e.data.cartTotal._id),K(e.data.selectedAddressId)):y(e.data.message)}catch(a){var s;(null===(s=a.response)||void 0===s?void 0:s.status)===401?e():console.error("Error fetching cart total:",a.message)}finally{P(!1)}},l=localStorage.getItem("token");l?(b(!0),s(l),t(l),r(l)):e(),a()},[B]);let X=async()=>{if(!H){alert("Please select a delivery address.");return}P(!0);try{let e=localStorage.getItem("token");if(!e){y("No token found"),P(!1);return}let a=await c.Z.post("/api/saveCheckoutAddress",{addressId:H,cartTotalId:L,deliveryFee:z},{headers:{Authorization:"Bearer ".concat(e)}});a.data.success?B.push("/orderpayment"):y(a.data.message||"Failed to save address.")}catch(e){console.error("Error during checkout:",e),e.response&&e.response.data?y(e.response.data.message||"Network error, please try again later."):y("An unexpected error occurred. Please try again later.")}finally{P(!1)}},U=I?I.subtotal:0,Y=I?I.itemDiscount:0,J=I?I.couponDiscount:0,Q=I?I.totalGst:0,W=I?I.deliveryFee:0;I&&I.total;let $=async e=>{if(!f[e]){console.error("Invalid address selected.");return}let a=f[e].location;if(A(f[e]),K(f[e]._id),!T){console.error("Admin location is not defined."),D(e=>({...e,deliveryFee:0}));return}try{let e=await c.Z.post("/api/calculateDeliveryFee",{userLocation:a,adminLocation:T});if(e.data.success){let{fee:a,distance:s}=e.data;R(a),D(e=>({...e,deliveryFee:a}))}else console.warn("Delivery fee calculation failed:",e.data.message),D(e=>({...e,deliveryFee:0}))}catch(e){console.error("Error calculating delivery fee:",e.message||e),D(e=>({...e,deliveryFee:0}))}finally{}};return(0,r.useEffect)(()=>{if(!f||!T||!H)return;let e=f.find(e=>e._id===H);if(!e){console.error("Selected address not found.");return}let a=e.location;(async()=>{try{let e=await c.Z.post("/api/calculateDeliveryFee",{userLocation:a,adminLocation:T});if(e.data.success){let{fee:a,distance:s}=e.data;R(a),D(e=>({...e,deliveryFee:a}))}else console.warn("Delivery fee calculation failed:",e.data.message),D(e=>({...e,deliveryFee:0}))}catch(e){console.error("Error calculating delivery fee:",e.message||e),D(e=>({...e,deliveryFee:0}))}})()},[f,T,H]),(0,t.jsxs)(t.Fragment,{children:[w&&!S&&(0,t.jsx)(u.Z,{setShowLogin:k,setIsLoggedIn:b}),(0,t.jsx)("div",{className:"back-navbar",children:(0,t.jsx)("div",{className:"app",children:(0,t.jsxs)("div",{className:"navbar-fixed",children:[(0,t.jsx)(n.Z,{isLoggedIn:S,setShowLogin:k,handleLogout:()=>{localStorage.removeItem("token"),b(!1),k(!0),B.push("/")}}),(0,t.jsx)("div",{className:"back-arrow",children:(0,t.jsx)(l.G,{icon:o.acZ,className:"back-arrow-icon",onClick:()=>B.back()})})]})})}),(0,t.jsx)("div",{className:"app",children:(0,t.jsxs)("div",{className:"cart-page",children:[(0,t.jsx)("div",{className:"back-arrow",children:(0,t.jsx)(l.G,{icon:o.acZ,className:"back-arrow-icon",onClick:()=>window.history.back()})}),(0,t.jsxs)("div",{className:"place-order",children:[(0,t.jsxs)("div",{className:"place-order-left",children:[(0,t.jsxs)("div",{className:"address-header",children:[(0,t.jsx)(l.G,{icon:o.FGq,className:"location-icon"}),(0,t.jsx)("h2",{children:"Delivery Addresses"})]}),f.length>0&&(0,t.jsx)("div",{className:"address-list",children:f.map((e,a)=>(0,t.jsxs)("div",{className:"address-item",children:[(0,t.jsx)("input",{type:"radio",name:"saved-address",value:a,checked:e._id===H,onChange:()=>$(a)}),(0,t.jsxs)("span",{children:[e.flatNo,", ",e.location]})]},a))}),(0,t.jsxs)("p",{className:"add-new-btn",onClick:()=>a(!0),children:[(0,t.jsx)("span",{children:(0,t.jsx)(l.G,{icon:o.r8p,className:"location-icon1"})})," ",(0,t.jsx)("span",{className:"add-new",children:" Add New Address"})]})]}),(0,t.jsx)("div",{className:"place-order-right",children:(0,t.jsx)("div",{className:"cart-bottom1",children:(0,t.jsxs)("div",{className:"cart-total",children:[(0,t.jsx)("h2",{children:"Cart Total"}),(0,t.jsxs)("div",{className:"cart-total-details",children:[(0,t.jsx)("p",{children:"Subtotal"}),(0,t.jsxs)("p",{children:["₹",U.toFixed(2)]})]}),(0,t.jsx)("hr",{}),Y>0&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"cart-total-details",children:[(0,t.jsx)("p",{children:"Item Discount"}),(0,t.jsxs)("p",{children:["-₹",Y.toFixed(2)]})]}),(0,t.jsx)("hr",{})]}),J>0&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"cart-total-details",children:[(0,t.jsx)("p",{children:"Coupon Discount"}),(0,t.jsxs)("p",{children:["-₹",Math.round(J).toFixed(2)]})]}),(0,t.jsx)("hr",{})]}),Q>0&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"cart-total-details",children:[(0,t.jsx)("p",{children:"GST"}),(0,t.jsxs)("p",{children:["+₹",Q.toFixed(2)]})]}),(0,t.jsx)("hr",{})]}),(0,t.jsxs)("div",{className:"cart-total-details",children:[(0,t.jsx)("p",{children:"Delivery Fee"}),(0,t.jsxs)("p",{children:["+₹","number"==typeof(null==I?void 0:I.deliveryFee)?I.deliveryFee.toFixed(2):"0"]})]}),(0,t.jsx)("hr",{}),(0,t.jsxs)("div",{className:"cart-total-details",children:[(0,t.jsx)("b",{children:"Total"}),(0,t.jsxs)("b",{children:["₹",(U+Q+W-Y-J).toFixed(2)]})]}),(0,t.jsx)("div",{className:"checkout-btn",children:(0,t.jsx)("button",{onClick:X,className:"checkout-button",disabled:0===F.length,children:_?"Processing...":"PROCEED TO PAYMENT"})})]})})}),e&&(0,t.jsx)(d,{setShowPopup:a,location:s,setLocation:m,flatNo:p,setFlatNo:g,landmark:v,setLandmark:x,adminLocation:T,distanceThreshold:M,setSavedAddresses:j})]})]})}),(0,t.jsx)(i.Z,{})]})}}},function(e){e.O(0,[976,603,128,66,221,500,888,774,179],function(){return e(e.s=77293)}),_N_E=e.O()}]);